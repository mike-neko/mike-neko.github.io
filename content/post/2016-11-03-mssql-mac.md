+++
categories = ["mac", "server"]
tags = ["php", "db"]
date = "2016-11-03T19:24:51+09:00"
draft = false
slug = "mssql-mac"
title = "MacからSQLServerへ接続"

+++

MacのPHP5.6からSQLServer(MSSQL)へ接続する方法
<!--more-->
CentOSの場合は[こちら](../mssql-cent/)

## 子ネタ
`SQLServer`へPHPから接続するには以下の方法がある

- [PDO_SQLSR](http://php.net/manual/ja/ref.pdo-sqlsrv.php)  
  - **Windows版のPHPでしか使えない**
- [PDO_DBLIB](http://php.net/manual/ja/ref.pdo-dblib.php)  
  - `FreeTDS`ライブラリを利用する
  - **Windows版はPHP5.3以降使えない**
- [PDO_ODBC](http://php.net/manual/ja/ref.pdo-odbc.php)  
  - Microsoftのドライバが必要(Win or Linuxのみ) => **Macは使えない**

という訳で、Macからの場合は`PDO_DBLIB`+`FreeTDS`一択、
Linuxの場合は`PDO_ODBC`+公式ドライバ（おすすめ？） or `PDO_DBLIB`+`FreeTDS`となる

## 手順
### FreeTDSのインストール
1. `Homebrew`で`FreeTDS`をインストール
```
brew install freetds
```

1. `FreeTDS`の接続確認
```
tsql -H (SQLServerのアドレス) -p (ポート) -U (ユーザ名) -P (パスワード)
```
として
```
locale is "ja_JP.UTF-8"
locale charset is "UTF-8"
using default charset "UTF-8"
1> 
```
のようになれば`exit`で終了  
`1>`の部分の数字が変わっていく場合は接続がうまくいっていない

*試した開発環境ではかなりの頻度でタイムアウトのエラーが出ていたので何度か試してみること*

### PDO_DBLIBのインストール
1. `Homebrew`で`PDO_DBLIB`をインストール
```
brew install homebrew/php/php56-pdo-dblib
```

1. 設定の確認
```
php --ri pdo_dblib
```
を実行して、
```
PDO Driver for FreeTDS/Sybase DB-lib => enabled
Flavour => freetds
```
と出ていればOK

## PHPからの接続
PDOのDSNの指定は以下の通り
```
$user = 'test';             // ユーザ名
$pass = '1234';             // パスワード
$host = '192.168.0.10';     // ホスト
$port = '1433';             // ポート番号
$db = 'sample';             // データベース名

$pdo = new PDO('dblib:host=' . $host . ':' . $port . ';dbname=' $db, 
               $user, $pass); 
```

## PHPStormの設定
`PHPStorm`から接続したい場合の設定は以下の感じ

{{< img "phpstorm.png" >}}

# 参考リンク
- PHP公式 [PDO_DBLIB](http://php.net/manual/ja/ref.pdo-dblib.php)
- FreeTDS [公式](http://www.freetds.org/)

# 開発環境
- Mac 10.11
- PHP 5.6.27 + PDO_DBLIB
- FreeTDS 1.00.15 (TDS 7.3)
- DBサーバ SQLServer Express 2016(Win)
