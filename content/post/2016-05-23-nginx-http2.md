+++
categories = ["iOS", "mac", "server"]
tags = ["docker", "php", "db", "nginx", "ssl", "http2"]
date = "2016-06-03T21:29:36+09:00"
draft = false
slug = "nginx-http2"
title = "nginxをhttp2に対応させる"

+++

以前に構築したDockerでの開発環境で使ったnginxを`http2`に対応させた時のメモ。

<!--more-->

> 過去の記事（[Dockerでの開発環境](../docker/)）

### 環境
ベースは前回構築したnginx+Dockerで通信はオレオレ証明書によるSSLを前提。

主な変更点は以下の通り

- OpenSSL 1.0.2
- nginx 1.10.0

いずれもhttp2対応させる為にバージョンアップが必要。

なお、iOSは**iOS9**からhttp2へ対応している。

## 手順
### 事前準備
http2での通信かどうかの確認用に以下のChromeのプラグインを入れておく。

[HTTP/2 and SPDY indicator](https://chrome.google.com/webstore/detail/http2-and-spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin/related?hl=ja)  
（Firefox用もあるみたいなのでお好きな方で）

http2での通信だと稲妻が青色になるので確認が楽。

### Macでの作業
1. OpenSSLを最新にあげる  
OpenSSLの更新方法：[Mac OS X の openssl を最新の状態にする](http://qiita.com/Chrowa3/items/b04e772be959cdda9ac3)  
ポイントは`upgrade`にすること（普段使う`update`ではない）

1. nginxをアンイストールする  
```
brew uninstall nginx
```

1. nginxをhttp2モジュール付きでインストールする
```
brew install nginx --with-http2
```

1. nginxのconfを編集  
`HTTPS server`の設定が`listen  443 ssl;`となっているはずなので、`http2`を追加する。
```
server {
    listen  443 ssl http2;
    ...
}
```
追加したらnginxを再起動する

1. ChromeからMacへアクセスしてみて青い稲妻になっていれば`nginx`の設定は成功

### iOS端末での通信
iOS9以降の`NSURLSession`での通信であれば、特に設定など不要で自動で`http2`になる。

なお、規格上は`http`のみでも対応しているがiOSでどうかは未検証。

### ログ設定
iOS端末からの通信も`http2`になっているかの確認は、`nginx`のログで判別する。

`http2`の場合は、`log_format`の`$http2`に`h2`と入ってくる。  
詳細は以下のページを参考に  
[nginxでアクセスログにhttp2の通信か出力する](http://d.hatena.ne.jp/ASnoKaze/20150818/1439896998)

## 過去情報
標準の`nginx`に`http2`モジュールがないと思っていたら、
実はちゃんとあったので訂正。

もったいないので、`nginx-full`の情報を残しておく。

### nginx-full
通常の`Homebrew`の`nginx`ではオプションのモジュールが少ないので、
標準では足りないモジュールをインストールしたい時は`nginx-full`をインストールする。  

例） nginxをhttp2モジュール付きでインストールする
```
brew tap homebrew/nginx
brew install nginx-full --with-http2
```
モジュールの一覧は以下で確認すること。
（[公式](https://nginx.org/en/docs/http/ngx_http_v2_module.html)のモジュールの情報?とは違うようなのでこれで確認）
```
brew info nginx-full
```

# 参考リンク
- [Mac - homebrewでnginxを入れるときはnginx-fullを入れよう](http://kannokanno.hatenablog.com/entry/2014/02/10/134920)

# 開発環境
+ OS X 10.11.5
+ Xcode 7.3.1
+ iOS 9.3.2
+ iPhone 6+

